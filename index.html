<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Pong rÃ©tro â€“ Deux joueurs</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    :root{
      --yellow:#ffd84d;
      --black:#000;
    }
    *{box-sizing:border-box}
    html,body{
      height:100%; margin:0; background:var(--yellow); color:var(--black);
      font-family:"Press Start 2P", system-ui, sans-serif;
    }
    .wrap{
      min-height:100%; display:flex; align-items:center; justify-content:center; padding:16px;
    }
    .stage-wrap{
      position:relative;
      width:min(96vw, 96vh*16/9);
      height:calc(min(96vw, 96vh*16/9)/(16/9));
      background:var(--yellow);
      border:4px solid var(--black);
      image-rendering:pixelated; image-rendering:crisp-edges;
      box-shadow:0 8px 0 var(--black);
      overflow:hidden;
    }
    canvas{ position:absolute; inset:0; width:100%; height:100%; image-rendering:pixelated; image-rendering:crisp-edges; z-index:1; }

    .net{
      position:absolute; top:0; bottom:0; left:50%; width:6px; transform:translateX(-50%);
      background-image:linear-gradient(var(--black) 50%, rgba(0,0,0,0) 50%);
      background-size:6px 20px; opacity:.25; pointer-events:none; z-index:2;
    }

    .hud{
      position:absolute; left:0; right:0; top:0; z-index:3;
      display:flex; justify-content:space-between; align-items:center;
      padding:10px 14px; user-select:none;
    }
    .logo{letter-spacing:1px; font-size:min(3.4vw,22px)}
    .score{
      font-size:min(6vw,42px);
      line-height:1;
      padding:6px 10px;
      border:4px solid var(--black);
      background:var(--yellow);
      box-shadow:0 6px 0 var(--black);
    }
    .score.flash{animation:flash .18s ease-out}
    @keyframes flash{
      from{transform:scale(1.12)}
      to{transform:scale(1)}
    }

    .menu, .modal{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; z-index:4; }
    .card{
      background:var(--yellow); border:4px solid var(--black); box-shadow:0 8px 0 var(--black);
      padding:24px; text-align:center; max-width:min(90%,520px);
    }
    .card h1{font-size:20px; margin:0 0 16px}
    .btn{
      display:inline-block; margin:8px 0 0; padding:12px 16px; border:4px solid var(--black);
      background:var(--yellow); color:var(--black); cursor:pointer; text-decoration:none;
      box-shadow:0 6px 0 var(--black); transition:transform .02s; font-size:14px;
      font-family:"Press Start 2P", system-ui, sans-serif;
    }
    .btn:active{ transform:translateY(3px); box-shadow:0 3px 0 var(--black); }

    .modal-backdrop{ position:absolute; inset:0; background:rgba(0,0,0,0.15); display:flex; align-items:center; justify-content:center; }
    .modal h2{font-size:18px; margin:0 0 16px}
    .small{font-size:12px; opacity:.8}

    .help{
      position:absolute; left:50%; bottom:8px; transform:translateX(-50%);
      font-size:min(2.8vw,14px); opacity:.75; text-align:center; line-height:1.5; pointer-events:none; z-index:3;
    }

    .sound{
      position:absolute; right:10px; bottom:10px; font-size:min(2.8vw,14px);
      border:4px solid var(--black); background:var(--yellow); box-shadow:0 6px 0 var(--black);
      padding:8px 10px; cursor:pointer; z-index:3;
    }
    .sound:active{ transform:translateY(3px); box-shadow:0 3px 0 var(--black); }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="stage-wrap" id="stage">
      <div class="hud">
        <div class="logo">PONG</div>
        <div class="score" id="score">0 â€” 0</div>
      </div>

      <div class="net" aria-hidden="true"></div>
      <canvas id="game" width="800" height="450"></canvas>
      <canvas id="fx" width="800" height="450" aria-hidden="true"></canvas>

      <!-- Menu -->
      <div class="menu" id="menu">
        <div class="card">
          <h1>Pong rÃ©tro</h1>
          <p class="small">J1: Z/S Â· J2: â†‘/â†“</p>
          <button class="btn" id="play5">Jouer en 5 points</button>
        </div>
      </div>

      <!-- Modal victoire -->
      <div class="modal" id="winModal" style="display:none;">
        <div class="modal-backdrop">
          <div class="card">
            <h2 id="winText">Joueur 1 gagne !</h2>
            <button class="btn" id="retry">Rejouer</button>
          </div>
        </div>
      </div>

      <button class="sound" id="soundBtn">ðŸ”Š Son: ON</button>
      <div class="help">1er Ã  5 gagne Â· AccÃ©lÃ©ration tous les 5 rebonds</div>
    </div>
  </div>

  <script>
    // === Constantes ===
    const WIDTH = 800, HEIGHT = 450;
    const PADDLE_W = 12, PADDLE_H = 90;
    const PADDLE_SPEED = 380;
    const PADDLE_X_MARGIN = 20;
    const BALL_SIZE = 10;
    const BALL_SPEED_START = 420;   // plus rapide dÃ¨s le dÃ©part
    const BALL_SPEED_MAX = 900;     // plafond
    const SPEED_STEP = 90;          // + vitesse Ã  chaque palier de rebonds
    const REBOUNDS_PER_STEP = 5;    // accÃ©lÃ©ration tous les 5 rebonds
    const POINTS_TO_WIN = 5;

    // === DOM ===
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const fxCanvas = document.getElementById('fx');
    const fctx = fxCanvas.getContext('2d');
    const scoreEl = document.getElementById('score');
    const menu = document.getElementById('menu');
    const play5Btn = document.getElementById('play5');
    const winModal = document.getElementById('winModal');
    const winText = document.getElementById('winText');
    const retryBtn = document.getElementById('retry');
    const soundBtn = document.getElementById('soundBtn');

    // === Ã‰tat ===
    let running = false;
    let gameOver = false;
    let scoreL = 0, scoreR = 0;

    // Paddles (mouvements verticaux uniquement)
    const left = { x: PADDLE_X_MARGIN, y: HEIGHT/2 - PADDLE_H/2, vy: 0 };
    const right = { x: WIDTH - PADDLE_X_MARGIN - PADDLE_W, y: HEIGHT/2 - PADDLE_H/2, vy: 0 };

    // Balle
    const ball = { x: WIDTH/2, y: HEIGHT/2, vx: 0, vy: 0, speed: BALL_SPEED_START };

    // Rebonds
    let reboundCount = 0;
    function countReboundAndMaybeSpeedUp(){
      reboundCount++;
      if (reboundCount % REBOUNDS_PER_STEP === 0){
        ball.speed = Math.min(BALL_SPEED_MAX, ball.speed + SPEED_STEP);
        // recalcule vx/vy avec la nouvelle vitesse sans changer l'angle
        const ang = Math.atan2(ball.vy, ball.vx);
        ball.vx = Math.cos(ang) * ball.speed;
        ball.vy = Math.sin(ang) * ball.speed;
      }
    }

    // Clavier
    const keys = new Set();
    window.addEventListener('keydown', e=>{
      const k = e.key.toLowerCase();
      if (["arrowup","arrowdown"].includes(k)) e.preventDefault();
      keys.add(k);
    }, {passive:false});
    window.addEventListener('keyup', e=>keys.delete(e.key.toLowerCase()));
    window.addEventListener('blur', ()=>keys.clear());

    // === Audio rÃ©tro simple (WebAudio) ===
    let audio, audioEnabled = true, audioReady = false;
    function initAudio(){
      if (!audioReady){
        audio = new (window.AudioContext || window.webkitAudioContext)();
        audioReady = true;
      }
    }
    function beep(freq=440, dur=0.06, type='square', gain=0.05){
      if (!audioEnabled || !audioReady) return;
      const t0 = audio.currentTime;
      const o = audio.createOscillator();
      const g = audio.createGain();
      o.type = type;
      o.frequency.setValueAtTime(freq, t0);
      g.gain.setValueAtTime(0, t0);
      g.gain.linearRampToValueAtTime(gain, t0+0.005);
      g.gain.exponentialRampToValueAtTime(0.0001, t0+dur);
      o.connect(g).connect(audio.destination);
      o.start(t0);
      o.stop(t0+dur+0.02);
    }
    const sfx = {
      click: ()=>beep(420, 0.08, 'square', 0.05),
      paddle: ()=>beep(620, 0.04, 'square', 0.05),
      wall: ()=>beep(280, 0.03, 'square', 0.04),
      score: ()=>{ beep(220,0.07,'square',0.06); setTimeout(()=>beep(165,0.08,'square',0.06), 40); },
      win: ()=>{ beep(660,0.09,'square',0.07); setTimeout(()=>beep(880,0.12,'square',0.07), 120); setTimeout(()=>beep(1100,0.15,'square',0.07), 240); },
    };

    soundBtn.addEventListener('click', ()=>{
      initAudio(); audioEnabled = !audioEnabled;
      soundBtn.textContent = audioEnabled ? "ðŸ”Š Son: ON" : "ðŸ”‡ Son: OFF";
      sfx.click();
    });

    // === Confettis ===
    let confetti = [];
    function spawnConfetti() {
      confetti = [];
      const N = 140;
      for (let i=0;i<N;i++){
        confetti.push({
          x: Math.random()*WIDTH,
          y: -Math.random()*HEIGHT*0.5,
          w: 2+Math.floor(Math.random()*3),
          h: 4+Math.floor(Math.random()*3),
          vy: 80+Math.random()*220,
          vx: -60+Math.random()*120,
          rot: Math.random()*Math.PI*2,
          vr: -4+Math.random()*8,
        });
      }
    }

    // Utils
    function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
    function rectsOverlap(ax,ay,aw,ah,bx,by,bw,bh){
      return ax < bx+bw && ax+aw > bx && ay < by+bh && ay+ah > by;
    }

    // Nouvelle mise en jeu: horizontale, raquettes recentrÃ©es, compteur rebonds remis Ã  zÃ©ro
    function resetRound(toLeft = Math.random()<0.5){
      left.y = HEIGHT/2 - PADDLE_H/2;
      right.y = HEIGHT/2 - PADDLE_H/2;
      left.vy = 0; right.vy = 0;
      ball.x = WIDTH/2; ball.y = HEIGHT/2;
      ball.speed = BALL_SPEED_START;
      ball.vx = (toLeft ? -1 : 1) * ball.speed;
      ball.vy = 0;
      reboundCount = 0;
    }

    // Score
    function updateScore(){
      scoreEl.textContent = `${scoreL} â€” ${scoreR}`;
      scoreEl.classList.remove('flash'); void scoreEl.offsetWidth; scoreEl.classList.add('flash');
    }

    function endGame(winner){
      running = false;
      gameOver = true;
      winText.textContent = `Joueur ${winner} gagne !`;
      winModal.style.display = "flex";
      spawnConfetti();
      sfx.win();
    }

    function hardReset(){
      scoreL = 0; scoreR = 0; updateScore();
      gameOver = false;
      winModal.style.display = "none";
      fctx.clearRect(0,0,WIDTH,HEIGHT);
      resetRound(Math.random()<0.5);
    }

    // === Boucle ===
    let last = 0;
    const keysDown = new Set();
    const P1_UP = 'z', P1_DOWN = 's';
    const P2_UP = 'arrowup', P2_DOWN = 'arrowdown';

    window.addEventListener('keydown', e=>{
      const k = e.key.toLowerCase();
      if ([P2_UP,P2_DOWN].includes(k)) e.preventDefault();
      keysDown.add(k);
    }, {passive:false});
    window.addEventListener('keyup', e=>keysDown.delete(e.key.toLowerCase()));

    function loop(ts){
      if (!running) { requestAnimationFrame(loop); return; }
      if (!last) last = ts;
      const dt = Math.min(0.033, (ts-last)/1000);
      last = ts;

      // EntrÃ©es verticales
      left.vy = 0;
      if (keysDown.has(P1_UP)) left.vy -= PADDLE_SPEED;
      if (keysDown.has(P1_DOWN)) left.vy += PADDLE_SPEED;

      right.vy = 0;
      if (keysDown.has(P2_UP)) right.vy -= PADDLE_SPEED;
      if (keysDown.has(P2_DOWN)) right.vy += PADDLE_SPEED;

      left.y = clamp(left.y + left.vy*dt, 0, HEIGHT-PADDLE_H);
      right.y = clamp(right.y + right.vy*dt, 0, HEIGHT-PADDLE_H);

      // Balle
      ball.x += ball.vx*dt;
      ball.y += ball.vy*dt;

      // Mur haut/bas
      if (ball.y <= 0){
        ball.y = 0; ball.vy = Math.abs(ball.vy);
        countReboundAndMaybeSpeedUp();
        sfx.wall();
      }
      if (ball.y + BALL_SIZE >= HEIGHT){
        ball.y = HEIGHT-BALL_SIZE; ball.vy = -Math.abs(ball.vy);
        countReboundAndMaybeSpeedUp();
        sfx.wall();
      }

      // Collisions paddles
      const hitLeft = rectsOverlap(ball.x, ball.y, BALL_SIZE, BALL_SIZE, left.x, left.y, PADDLE_W, PADDLE_H);
      const hitRight = rectsOverlap(ball.x, ball.y, BALL_SIZE, BALL_SIZE, right.x, right.y, PADDLE_W, PADDLE_H);
      if (hitLeft){
        ball.x = left.x + PADDLE_W;
        const rel = ((ball.y + BALL_SIZE/2) - (left.y + PADDLE_H/2)) / (PADDLE_H/2);
        const maxAngle = Math.PI * 0.35;
        const angle = rel * maxAngle;
        // applique nouvelle vitesse si palier atteint
        countReboundAndMaybeSpeedUp();
        ball.vx = Math.cos(angle) * ball.speed; // vers droite
        ball.vy = Math.sin(angle) * ball.speed;
        sfx.paddle();
      } else if (hitRight){
        ball.x = right.x - BALL_SIZE;
        const rel = ((ball.y + BALL_SIZE/2) - (right.y + PADDLE_H/2)) / (PADDLE_H/2);
        const maxAngle = Math.PI * 0.35;
        const angle = rel * maxAngle;
        countReboundAndMaybeSpeedUp();
        ball.vx = -Math.cos(angle) * ball.speed; // vers gauche
        ball.vy = Math.sin(angle) * ball.speed;
        sfx.paddle();
      }

      // But
      if (ball.x + BALL_SIZE < 0){
        scoreR++; updateScore(); sfx.score();
        if (scoreR >= POINTS_TO_WIN) endGame(2);
        else resetRound(false);
      } else if (ball.x > WIDTH){
        scoreL++; updateScore(); sfx.score();
        if (scoreL >= POINTS_TO_WIN) endGame(1);
        else resetRound(true);
      }

      // FX confettis
      if (gameOver){
        fctx.clearRect(0,0,WIDTH,HEIGHT);
        for (const c of confetti){
          c.x += c.vx*dt; c.y += c.vy*dt; c.rot += c.vr*dt;
          if (c.y > HEIGHT+20){ c.y = -20; c.x = Math.random()*WIDTH; }
          fctx.save();
          fctx.translate(Math.round(c.x), Math.round(c.y));
          fctx.rotate(c.rot);
          fctx.fillStyle = (Math.random()<.5) ? "#000" : "#111";
          fctx.fillRect(-c.w/2, -c.h/2, c.w, c.h);
          fctx.restore();
        }
      } else {
        fctx.clearRect(0,0,WIDTH,HEIGHT);
      }

      // Rendu
      render();
      requestAnimationFrame(loop);
    }

    function render(){
      // fond
      ctx.fillStyle = "#ffd84d";
      ctx.fillRect(0,0,WIDTH,HEIGHT);
      // paddles + balle
      ctx.fillStyle = "#000";
      ctx.fillRect(Math.round(left.x), Math.round(left.y), PADDLE_W, PADDLE_H);
      ctx.fillRect(Math.round(right.x), Math.round(right.y), PADDLE_W, PADDLE_H);
      ctx.fillRect(Math.round(ball.x), Math.round(ball.y), BALL_SIZE, BALL_SIZE);
    }

    // UI
    play5Btn.addEventListener('click', ()=>{
      initAudio(); sfx.click();
      menu.style.display = "none";
      hardReset();
      running = true; last = 0;
      requestAnimationFrame(loop);
    });

    retryBtn.addEventListener('click', ()=>{
      sfx.click();
      hardReset(); running = true; last = 0;
      requestAnimationFrame(loop);
    });

    // boucle idle
    requestAnimationFrame(loop);
  </script>
</body>
</html>
